<% content_for :title, "Feed" %>

<div class="container">
  <div class="header">
    <h1>üì∞ Your Feed</h1>
    <div class="user-info">
      <%= link_to "‚úèÔ∏è Create Post", new_post_path, class: "btn btn-primary" %>
      <%= link_to "üë• Find Friends", users_path, class: "btn btn-secondary" %>
    </div>
  </div>
  
  <% if @friends_count >= 0 %>
    <p class="peer-count">Posts from your <%= pluralize(@friends_count, 'friend') %></p>
  <% end %>

  <% if @posts.any? %>
    <div class="message-list">
      <% @posts.each do |post| %>
        <div class="message-item post" data-post-id="<%= post.id %>" data-has-media="<%= post.has_media? %>">
          <div class="message-header">
            <div class="author">
              <%= post.user.display_name || post.user.username %> (@<%= post.user.username %>)
            </div>
            <div class="timestamp" data-timestamp="<%= post.timestamp.iso8601 %>">
              <%= time_ago_in_words(post.timestamp) %> ago ‚Ä¢ üîí Encrypted
            </div>
          </div>

          <div class="message-content">
            <% if post.content.present? %>
              <%= simple_format(post.content) %>
            <% end %>
            
            <% if post.attachments.any? %>
              <div class="attachments-section">
                <% post.attachments.each do |attachment| %>
                  <div class="attachment-item">
                    <% if attachment.content_type.start_with?('image/') %>
                      üñºÔ∏è
                    <% elsif attachment.content_type.start_with?('video/') %>
                      üé•
                    <% elsif attachment.content_type.start_with?('audio/') %>
                      üéµ
                    <% else %>
                      üìé
                    <% end %>
                    <%= link_to attachment.filename, post_attachment_path(post, attachment), target: "_blank", class: "attachment-link" %>
                    (<%= number_to_human_size(attachment.file_size) %>)
                  </div>
                <% end %>
              </div>
            <% end %>
          </div>

          <% if post.comments.any? %>
            <div class="comments-section">
              <h4><%= pluralize(post.comments.count, 'comment') %></h4>
              <% post.comments.recent.limit(3).each do |comment| %>
                <div class="comment-item">
                  <div class="comment-header">
                    <span class="comment-author"><%= comment.user.username %></span>
                    <span class="comment-timestamp"><%= time_ago_in_words(comment.timestamp) %> ago</span>
                    <% if comment.user == current_user_session %>
                      <%= button_to "√ó", post_comment_path(post, comment), method: :delete, 
                                    confirm: "Delete this comment?",
                                    class: "btn btn-small btn-danger" %>
                    <% end %>
                  </div>
                  <div class="comment-content">
                    <%= comment.content %>
                  </div>
                </div>
              <% end %>
              
              <% if post.comments.count > 3 %>
                <div class="view-all-comments">
                  <%= link_to "View all #{post.comments.count} comments", post_path(post), 
                              class: "btn btn-secondary btn-small" %>
                </div>
              <% end %>
            </div>
          <% end %>

          <div class="comment-form-section">
            <%= form_with model: [post, Comment.new], local: true, class: "comment-form" do |form| %>
              <div class="form-group">
                <%= form.text_field :content, placeholder: "Write a comment...", 
                                    class: "form-control",
                                    required: true %>
              </div>
              <%= form.submit "Post", class: "btn btn-primary btn-small" %>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  <% else %>
    <div class="welcome">
      <h2>No posts yet</h2>
      <% if @friends_count == 0 %>
        <p>You don't have any friends yet</p>
        <div class="form-actions">
          <%= link_to "Find Friends", users_path, class: "btn btn-primary btn-large" %>
          <%= link_to "‚úèÔ∏è Create Your First Post", new_post_path, class: "btn btn-secondary btn-large" %>
        </div>
      <% else %>
        <p>Your friends haven't posted anything yet. Be the first to share something interesting!</p>
        <div class="form-actions">
          <%= link_to "‚úèÔ∏è Create Your First Post", new_post_path, class: "btn btn-primary btn-large" %>
        </div>
      <% end %>
    </div>
  <% end %>
</div>

<style>
/* Feed-specific styles that complement the existing app styles */
.attachments-section {
  margin-top: 15px;
  padding: 10px;
  background: rgba(0, 0, 0, 0.02);
  border-radius: 8px;
  border: 1px solid rgba(0, 0, 0, 0.05);
}

.attachment-item {
  margin: 5px 0;
  font-size: 0.9em;
}

.attachment-link {
  color: #667eea;
  text-decoration: none;
  font-weight: 500;
}

.attachment-link:hover {
  text-decoration: underline;
}

.comments-section {
  margin-top: 20px;
  padding-top: 15px;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.comments-section h4 {
  margin: 0 0 15px 0;
  color: #495057;
  font-size: 1em;
}

.comment-item {
  background: rgba(0, 0, 0, 0.02);
  border-radius: 8px;
  padding: 10px;
  margin: 8px 0;
  border: 1px solid rgba(0, 0, 0, 0.05);
}

.comment-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 5px;
  font-size: 0.85em;
}

.comment-author {
  font-weight: 600;
  color: #667eea;
}

.comment-timestamp {
  color: #8e8e93;
}

.comment-content {
  color: #2d3748;
  line-height: 1.4;
}

.comment-form-section {
  margin-top: 20px;
  padding-top: 15px;
  border-top: 1px solid rgba(0, 0, 0, 0.1);
}

.comment-form {
  display: flex;
  gap: 10px;
  align-items: flex-end;
}

.comment-form .form-group {
  flex: 1;
  margin-bottom: 0;
}

.btn-small {
  padding: 6px 12px;
  font-size: 0.85em;
}

.btn-danger {
  background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
  color: white;
}

.view-all-comments {
  text-align: center;
  margin-top: 10px;
}
</style>
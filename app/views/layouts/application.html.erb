<!DOCTYPE html>
<html>
  <head>
    <title><%= content_for(:title) || "Cipher" %></title>
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <%= csrf_meta_tags %>
    <%= csp_meta_tag %>
    <% if current_user_session %>
      <meta name="current-user-id" content="<%= current_user_session.id %>">
    <% end %>
    
    <!-- Desktop app specific meta tags -->
    <% if Rails.env.desktop? %>
      <meta name="desktop-app" content="true">
      <meta http-equiv="Content-Security-Policy" content="default-src 'self' tauri: 'unsafe-inline' 'unsafe-eval'; connect-src 'self' ws: wss:;">
    <% end %>

    <%= yield :head %>

    <%# Enable PWA manifest for installable apps (make sure to enable in config/routes.rb too!) %>
    <%#= tag.link rel: "manifest", href: pwa_manifest_path(format: :json) %>

    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
    <link rel="icon" type="image/png" sizes="192x192" href="/android-chrome-192x192.png">
    <link rel="icon" type="image/png" sizes="512x512" href="/android-chrome-512x512.png">

    <%# Includes all stylesheet files in app/assets/stylesheets %>
    <%= stylesheet_link_tag "application", "layout", "desktop", "mobile", "homepage", "posts", "messages", "users", "hosting", "data-turbo-track": "reload" %>
    <%= javascript_importmap_tags %>
  </head>

  <body class="<%= 'env-desktop' if Rails.env.desktop? %> <%= 'env-ios platform-ios' if Rails.env.ios? %> <%= 'env-android platform-android' if Rails.env.android? %> <%= 'env-web' if Rails.env.development? || Rails.env.production? %>">
    <!-- Desktop app specific elements -->
    <% if Rails.env.desktop? %>
      <div class="desktop-titlebar" data-tauri-drag-region>
        <div class="desktop-titlebar-title">Cipher</div>
        <div class="desktop-titlebar-buttons">
          <button class="titlebar-button titlebar-minimize">‚àí</button>
          <button class="titlebar-button titlebar-maximize">‚ñ°</button>
          <button class="titlebar-button titlebar-close">√ó</button>
        </div>
      </div>
    <% end %>
    
    <div class="app-wrapper">
      <!-- Desktop native sidebar -->
      <% if Rails.env.desktop? %>
        <div class="desktop-sidebar">
          <div class="desktop-sidebar-header">
            <%= link_to root_path, class: "desktop-logo" do %>
              üîê Cipher
            <% end %>
          </div>
          
          <% if current_user_session %>
            <div class="desktop-user-section">
              <div class="desktop-user-info">
                <div class="desktop-username">Hi, <%= current_user_session.username %></div>
                <div class="desktop-peer-count"><%= current_user_session.peers.active.count %> peers online</div>
              </div>
              
              <div class="desktop-wallet-section">
                <div id="desktop-wallet-status" class="desktop-wallet-status">
                  <button id="desktop-connect-wallet-btn" class="desktop-btn primary">Connect Wallet</button>
                </div>
                <div id="desktop-wallet-connected" style="display: none;">
                  <div class="desktop-wallet-info">
                    <div class="desktop-balance" id="desktop-wallet-balance">0 CPH</div>
                    <div class="desktop-address" id="desktop-wallet-address"></div>
                  </div>
                  <div class="desktop-wallet-actions">
                    <button id="desktop-deposit-btn" class="desktop-btn">Deposit</button>
                    <button id="desktop-withdraw-btn" class="desktop-btn">Withdraw</button>
                  </div>
                </div>
              </div>
            </div>
            
            <nav class="desktop-nav">
              <div class="desktop-nav-section">
                <div class="desktop-nav-title">Main</div>
                <%= link_to root_path, class: "desktop-nav-link" do %>
                  üè† Home
                <% end %>
                <%= link_to feed_path, class: "desktop-nav-link" do %>
                  üì∞ Feed
                <% end %>
                <%= link_to posts_path, class: "desktop-nav-link" do %>
                  üìù Posts
                <% end %>
                <%= link_to friends_users_path, class: "desktop-nav-link" do %>
                  üë• Friends
                <% end %>
                <%= link_to messages_path, class: "desktop-nav-link" do %>
                  üí¨ Messages
                <% end %>
              </div>
              
              <div class="desktop-nav-section">
                <div class="desktop-nav-title">Network</div>
                <%= link_to local_hosting_users_path, class: "desktop-nav-link" do %>
                  Local Hosting
                <% end %>
                <%= link_to user_path(current_user_session), class: "desktop-nav-link" do %>
                  Profile
                <% end %>
              </div>
            </nav>
          <% else %>
            <div class="desktop-user-section">
              <div class="desktop-nav">
                <div class="desktop-nav-section">
                  <div class="desktop-nav-title">Get Started</div>
                  <%= link_to import_keys_users_path, class: "desktop-nav-link" do %>
                    Sign In
                  <% end %>
                  <%= link_to new_user_path, class: "desktop-nav-link" do %>
                    Create Account
                  <% end %>
                </div>
              </div>
            </div>
          <% end %>
        </div>
      <% end %>
      
      <!-- Unified header for all platforms -->
      <header class="app-header">
        <div class="header-container">
          <div class="header-left">
            <%= link_to root_path, class: "logo-link" do %>
              <span class="logo">üîê Cipher</span>
            <% end %>
          </div>
          
          <div class="header-right">
            <!-- Mobile menu toggle -->
            <input type="checkbox" id="mobile-menu-toggle" class="mobile-menu-toggle">
            <label for="mobile-menu-toggle" class="mobile-menu-button">‚ò∞</label>
            
            <% if current_user_session %>
              <div class="user-nav">
                <span class="user-greeting">Hi, <strong><%= current_user_session.username %></strong></span>
                <span class="peer-count"><%= current_user_session.peers.active.count %> peers</span>
                <nav class="nav-links">
                  <%= link_to "Feed", feed_path, class: "nav-link" %>
                  <%= link_to "Posts", posts_path, class: "nav-link" %>
                  <%= link_to "Friends", friends_users_path, class: "nav-link" %>
                  <%= link_to "Messages", messages_path, class: "nav-link" %>
                  <%= link_to "Local Hosting", local_hosting_users_path, class: "nav-link" %>
                  <%= link_to "Profile", user_path(current_user_session), class: "nav-link" %>
                </nav>
              </div>
            <% else %>
              <nav class="auth-nav">
                <%= link_to "Sign In", import_keys_users_path, class: "btn btn-secondary" %>
                <%= link_to "Create Account", new_user_path, class: "btn btn-primary" %>
              </nav>
            <% end %>
          </div>
        </div>
      </header>


      <% if flash.any? %>
        <div class="flash-messages">
          <% flash.each do |type, message| %>
            <div class="flash-message flash-<%= type %>">
              <%= message %>
            </div>
          <% end %>
        </div>
      <% end %>

      <main class="app-main">
        <%= yield %>
      </main>

      <footer class="app-footer">
        <div class="footer-container">
          <div class="footer-content">
            <div class="footer-section">
              <h4>Cipher</h4>
              <p>Secure, decentralized communication for the modern web</p>
              <div class="footer-links">
                <%= link_to "About", "#" %>
                <%= link_to "Security", "#" %>
                <%= link_to "Privacy", "#" %>
              </div>
            </div>
            
            <div class="footer-section">
              <h4>Community</h4>
              <div class="footer-links">
                <%= link_to "GitHub", "#" %>
                <%= link_to "Documentation", "#" %>
                <%= link_to "Support", "#" %>
              </div>
            </div>
          </div>
          
          <div class="footer-bottom">
            <div class="footer-info">
              <span>&copy; 2025 Cipher. Zero-knowledge by design.</span>
            </div>
            <div class="footer-badges">
              <span class="badge security-badge">üîê End-to-End Encrypted</span>
              <span class="badge privacy-badge">üõ°Ô∏è Zero-Knowledge</span>
              <span class="badge badge-success b-corp-badge">üå± Certified B Corporation</span>
            </div>
          </div>
        </div>
      </footer>
    </div>

    <!-- Minimal JavaScript - wallet functionality will be loaded on demand -->
    <script>
      // Simple notification system - no complex wallet management
      function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.textContent = message;
        notification.style.cssText = `
          position: fixed; top: 20px; right: 20px; z-index: 9999;
          background: ${type === 'success' ? '#48bb78' : type === 'error' ? '#f56565' : type === 'warning' ? '#ed8936' : '#4299e1'};
          color: white; padding: 12px 16px; border-radius: 8px; max-width: 300px;
          box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        `;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 5000);
      }
      
      // Make notification available globally
      window.showNotification = showNotification;
    </script>
    
    <!-- Minimal desktop app JavaScript -->
    <% if Rails.env.desktop? %>
      <script type="module">
        try {
          // Import Tauri API for desktop functionality
          const { appWindow } = await import('@tauri-apps/api/window');
          const { invoke } = await import('@tauri-apps/api/tauri');
          
          // Basic titlebar controls - CSS handles visibility
          const minimize = document.querySelector('.titlebar-minimize');
          const maximize = document.querySelector('.titlebar-maximize');
          const close = document.querySelector('.titlebar-close');
          
          minimize?.addEventListener('click', () => appWindow.minimize());
          maximize?.addEventListener('click', () => appWindow.toggleMaximize());
          close?.addEventListener('click', () => appWindow.hide());
          
          // Handle external links - open in system browser
          document.addEventListener('click', (e) => {
            const link = e.target.closest('a');
            if (link?.href?.startsWith('http') && !link.href.includes('localhost')) {
              e.preventDefault();
              invoke('open_external_url', { url: link.href });
            }
          });
          
        } catch (error) {
          console.log('Desktop functionality not available:', error.message);
        }
      </script>
    <% end %>
  </body>
</html>

<div class="container">
  <% if @current_user %>
    <div class="dashboard-welcome">
      <h1>Cipher Social Network</h1>
      <h2>Your Cipher Dashboard</h2>
      <p>Manage your encrypted communications and network connections.</p>
    </div>
    <section class="status-section">
      <h2>🌐 Network Status</h2>
      <div id="connection-status" class="status-offline">
        <span class="status-indicator">●</span> Connecting to P2P network...
      </div>
      <div id="peer-list" class="peer-list">
        <h3>Connected Peers</h3>
        <div id="connected-peers">No peers connected</div>
      </div>
    </section>

    <section class="status-section">
      <h2>💬 Messages & Posts</h2>
      <div class="quick-post-form">
        <%= form_with model: Post.new, url: posts_path, multipart: true, class: "inline-post-form" do |form| %>
          <div class="form-group">
            <%= form.text_area :content, placeholder: "What's on your mind?", rows: 3, class: "form-control" %>
          </div>
          <div class="form-group">
            <label for="attachments">Attachments</label>
            <input type="file" 
                   id="attachments"
                   name="attachments[]" 
                   class="file-input-visible" 
                   multiple 
                   accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt"
                   style="display: block; width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
          </div>
          <div class="form-buttons">
            <%= form.submit "📤 Post Securely", class: "btn btn-primary" %>
            <%= link_to "📋 View All Posts", posts_path, class: "btn btn-secondary" %>
          </div>
        <% end %>
      </div>
      
      <div id="message-list" class="message-list">
        <% if @current_user.posts.any? %>
          <% @current_user.posts.recent.limit(10).each do |post| %>
            <div class="message-item">
              <div class="message-header">
                <div class="message-meta">
                  <span class="author"><%= post.user.username %></span>
                  <span class="timestamp"><%= post.timestamp&.strftime("%b %d, %Y at %I:%M %p") %></span>
                </div>
                <div class="message-actions">
                  <%= link_to "🗑️", post_path(post), method: :delete, 
                      class: "btn-delete", 
                      title: "Delete post",
                      data: { 
                        confirm: "Are you sure you want to delete this post? This action cannot be undone.",
                        turbo_method: :delete
                      } %>
                </div>
              </div>
              <div class="message-content">
                <%= simple_format(post.content) if post.content %>
                <% if post.attachments.any? %>
                  <div class="attachments">
                    <% post.attachments.each do |attachment| %>
                      <% if attachment.is_image? %>
                        <div class="attachment-preview image-preview">
                          <div data-controller="image-decryption"
                               data-image-decryption-attachment-url-value="<%= post_attachment_path(post, attachment) %>"
                               data-image-decryption-filename-value="<%= attachment.filename %>"
                               data-image-decryption-filesize-value="<%= attachment.human_file_size %>"
                               data-image-decryption-content-type-value="<%= attachment.content_type %>">
                            <div class="loading-placeholder">
                              <span class="loading-icon">🔓</span>
                              <span class="loading-text">Decrypting image...</span>
                            </div>
                            <div class="image-overlay" style="display: none;">
                              <span class="filename"><%= attachment.filename %></span>
                              <span class="filesize"><%= attachment.human_file_size %></span>
                            </div>
                          </div>
                        </div>
                      <% elsif attachment.is_video? %>
                        <div class="attachment-preview video-preview">
                          <%= link_to post_attachment_path(post, attachment), target: '_blank', class: 'video-link' do %>
                            <div class="video-thumbnail">
                              🎥
                              <div class="video-info">
                                <span class="filename"><%= attachment.filename %></span>
                                <span class="filesize"><%= attachment.human_file_size %></span>
                              </div>
                            </div>
                          <% end %>
                        </div>
                      <% else %>
                        <div class="attachment file-attachment">
                          <%= link_to post_attachment_path(post, attachment), target: '_blank', class: 'file-link' do %>
                            📎 <%= attachment.filename %> (<%= attachment.human_file_size %>)
                          <% end %>
                        </div>
                      <% end %>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        <% else %>
          <div style="text-align: center; padding: 40px; color: #6c757d; font-style: italic;">
            <p>🌟 Welcome to your encrypted social network!</p>
            <p>Create your first message to get started.</p>
          </div>
        <% end %>
      </div>
    </section>
  <% else %>
    <div class="welcome-hero">
      <h2>Welcome to Cipher</h2>
      <p>Encrypted peer-to-peer messaging without servers.</p>
      
      <div class="getting-started">
        <%= link_to "Create Your Identity", new_user_path, class: "btn btn-primary btn-large" %>
      </div>
    </div>

    <div class="features">
      <div class="feature">
        <h3>🔐 End-to-End Encryption</h3>
        <p>Messages are encrypted before sending. Only you and your recipients can read them.</p>
      </div>
      
      <div class="feature">
        <h3>🌐 Peer-to-Peer</h3>
        <p>Direct connections between users. No servers required.</p>
      </div>
      
      <div class="feature">
        <h3>🔑 Self-Sovereign Identity</h3>
        <p>You control your identity. No external authorities involved.</p>
      </div>
      
      <div class="feature">
        <h3>📱 Decentralized</h3>
        <p>No central authority. Your communications stay independent.</p>
      </div>
    </div>

    <!-- Token Economy Section -->
    <section class="token-economy">
      <div class="token-content">
        <!-- CPH Token Hero Well -->
        <div class="cph-hero-well">
          <h2>🛡️ Cipher Token (CPH)</h2>
          <div class="token-intro">
            <p class="token-lead">
              A lightweight system to prevent network abuse. 
              Contribute storage to receive tokens, use tokens for content access.
            </p>
          </div>
        </div>
        
        <div class="token-mechanics">
          <div class="token-section">
            <div class="token-icon">🏠</div>
            <div class="token-info">
              <h3>Contribute by Hosting</h3>
              <p>Provide secure storage for encrypted files and receive CPH tokens for abuse prevention. Your device becomes part of a distributed network.
              <ul class="token-benefits">
                <li>Receive tokens for network participation</li>
                <li>Help prevent network abuse</li>
                <li>Support system sustainability</li>
              </ul>
            </div>
          </div>
          
          <div class="token-section">
            <div class="token-icon">👀</div>
            <div class="token-info">
              <h3>Access Content</h3>
              <p>Access files and media using CPH tokens to prevent abuse at 1 CPH per KB. Simple usage-based access with no subscriptions.
              <ul class="token-benefits">
                <li>1 CPH = 1 KB of data</li>
                <li>Usage-based access control</li>
                <li>Prevents spam and abuse</li>
              </ul>
            </div>
          </div>
        </div>
        
        <div class="token-privacy-guarantee">
          <div class="privacy-badge">
            <div class="privacy-icon">🛡️</div>
            <div class="privacy-text">
              <h4>Abuse Prevention System</h4>
              <p>
                <strong>Simple usage tracking.</strong> Token transactions prevent spam and abuse, 
                while your file contents, viewing habits, and personal data remain completely private and encrypted.
              </p>
            </div>
          </div>
        </div>
        
        <div class="token-getting-started">
          <h3>Ready to Join the Network?</h3>
          <p>Start contributing to the decentralized storage network to receive CPH tokens, or begin exploring content with our fair usage-based access model.</p>
          <div class="token-actions">
            <%= link_to "Start Local Hosting", local_hosting_users_path, class: "btn btn-primary-token" %>
            <%= link_to "Become a Network Host", host_dashboard_users_path, class: "btn btn-secondary-token" %>
            <%= link_to "Connect Wallet", "#", class: "btn btn-outline-token", id: "connect-wallet-cta" %>
          </div>
        </div>
      </div>
    </section>

    <!-- Mission Statement Section -->
    <section class="mission-statement">
      <div class="mission-content">
        <h2>🛡️ Our Mission</h2>
        <div class="mission-text">
          <p class="mission-lead">
            Private messaging without surveillance or data collection.
          </p>
          
          <div class="mission-principles">
            <div class="principle">
              <div class="principle-icon">🚫</div>
              <div class="principle-content">
                <h3>No Servers, No Surveillance</h3>
                <p>Messages go directly between users. No servers store your conversations.</p>
              </div>
            </div>
            
            <div class="principle">
              <div class="principle-icon">🔒</div>
              <div class="principle-content">
                <h3>No Data Harvesting</h3>
                <p>We can't read your messages or track you. Your data stays yours.</p>
              </div>
            </div>
            
            <div class="principle">
              <div class="principle-icon">📖</div>
              <div class="principle-content">
                <h3>Open Source Transparency</h3>
                <p>All code is public. Audit it, fork it, improve it.</p>
              </div>
            </div>
            
            <div class="principle">
              <div class="principle-icon">❤️</div>
              <div class="principle-content">
                <h3>Connect with Loved Ones</h3>
                <p>Share files and messages privately with friends and family.</p>
              </div>
            </div>
          </div>
          
          <div class="mission-call-to-action">
            <p class="mission-cta-text">
              <strong>Private messaging by design.</strong> 
              No tracking, no data collection, no surveillance.
            </p>
            <div class="mission-links">
              <a href="https://github.com/anthropics/cipher" target="_blank" class="btn btn-outline">
                📖 View Source Code
              </a>
              <%= link_to new_user_path, class: "btn btn-secondary" do %>
                🚀 Get Started
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </section>
  <% end %>
</div>

<% if @current_user %>
  <script type="module">
    import CipherSignaling from 'channels/signaling_channel';
    
    // Initialize P2P connection
    const signaling = new CipherSignaling(<%= @current_user.id %>);
    
    // Update UI based on connection status
    signaling.onConnected = function() {
      document.getElementById('connection-status').className = 'status-online';
      document.getElementById('connection-status').innerHTML = 
        '<span class="status-indicator">●</span> Connected to P2P network';
    };
    
    signaling.onDisconnected = function() {
      document.getElementById('connection-status').className = 'status-offline';
      document.getElementById('connection-status').innerHTML = 
        '<span class="status-indicator">●</span> Disconnected from P2P network';
    };
  </script>
<% else %>
  <script type="module">
    // Handle wallet connection from token section
    document.addEventListener('DOMContentLoaded', () => {
      const connectWalletBtn = document.getElementById('connect-wallet-cta');
      
      if (connectWalletBtn) {
        connectWalletBtn.addEventListener('click', (e) => {
          e.preventDefault();
          
          if (typeof window.cipherWallet !== 'undefined') {
            window.cipherWallet.connectWallet().then(() => {
              // Show success notification
              showTokenNotification('Wallet connected successfully! You can now earn and spend CPH tokens.', 'success');
            }).catch((error) => {
              showTokenNotification('Failed to connect wallet: ' + error.message, 'error');
            });
          } else {
            showTokenNotification('Please create an account first to connect your wallet.', 'info');
            setTimeout(() => {
              window.location.href = '<%= new_user_path %>';
            }, 2000);
          }
        });
      }
    });
    
    function showTokenNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `token-notification token-notification-${type}`;
      notification.textContent = message;
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
        color: white;
        padding: 16px 20px;
        border-radius: 12px;
        z-index: 10000;
        max-width: 350px;
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
        font-weight: 500;
        backdrop-filter: blur(10px);
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.remove();
      }, 5000);
    }
  </script>
<% end %>

<style>
.message-actions {
  display: flex;
  gap: 12px;
  margin-bottom: 20px;
  flex-wrap: wrap;
}

.message-actions .btn {
  font-size: 0.95em;
}

.form-buttons {
  display: flex;
  gap: 12px;
  margin-top: 15px;
  flex-wrap: wrap;
}

.form-buttons .btn {
  font-size: 0.95em;
}

/* Message header layout */
.message-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
}

.message-meta {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.message-header .message-actions {
  margin-bottom: 0;
  gap: 8px;
}

.btn-delete {
  background: transparent;
  border: none;
  color: #dc3545;
  text-decoration: none;
  font-size: 1.1em;
  padding: 4px 8px;
  border-radius: 4px;
  transition: background-color 0.2s ease;
  cursor: pointer;
}

.btn-delete:hover {
  background-color: rgba(220, 53, 69, 0.1);
  text-decoration: none;
}

@media (max-width: 768px) {
  .message-actions {
    flex-direction: column;
  }
  
  .message-header {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
  }
  
  .message-header .message-actions {
    align-self: flex-end;
  }
}
</style>

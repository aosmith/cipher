<div class="container">
  <% if @current_user %>
    <section class="status-section">
      <h2>🌐 Network Status</h2>
      <div class="status-online">
        <span class="status-indicator">●</span> Local server running
      </div>
      <div class="status-online">
        <% stun_status = stun_server_status %>
        <span class="status-indicator" style="color: <%= stun_status[:color] %>"><%= stun_status[:indicator] %></span> <%= stun_status[:status] %>
      </div>
    </section>

    <section class="status-section">
      <h2>💬 Messages & Posts</h2>
      <div class="quick-post-form">
        <%= form_with model: Post.new, url: posts_path, multipart: true, class: "inline-post-form" do |form| %>
          <div class="form-group">
            <%= form.text_area :content, placeholder: "What's on your mind?", rows: 3, class: "form-control" %>
          </div>
          <div class="form-group">
            <label for="attachments" class="form-label">Attachments</label>
            <input type="file"
                   id="attachments"
                   name="attachments[]"
                   class="form-control file-input-visible"
                   multiple
                   accept="image/*,video/*,audio/*,.pdf,.doc,.docx,.txt">
            <small class="form-help">Select images, videos, documents, or other files to attach</small>
          </div>
          <div class="form-buttons">
            <%= form.submit "📤 Post Securely", class: "btn btn-primary" %>
            <%= link_to "📋 View All Posts", posts_path, class: "btn btn-secondary" %>
          </div>
        <% end %>
      </div>
      
      <div id="message-list" class="message-list">
        <% if @current_user.posts.any? %>
          <% @current_user.posts.recent.limit(10).each do |post| %>
            <div class="message-item">
              <div class="message-header">
                <div class="message-meta">
                  <span class="author"><%= post.user.username %></span>
                  <span class="timestamp"><%= post.timestamp&.strftime("%b %d, %Y at %I:%M %p") %></span>
                </div>
                <div class="message-actions">
                  <%= link_to "🗑️", post_path(post), method: :delete, 
                      class: "btn-delete", 
                      title: "Delete post",
                      data: { 
                        confirm: "Are you sure you want to delete this post? This action cannot be undone.",
                        turbo_method: :delete
                      } %>
                </div>
              </div>
              <div class="message-content">
                <%= simple_format(post.content) if post.content %>
                <% if post.attachments.any? %>
                  <div class="attachments">
                    <% post.attachments.each do |attachment| %>
                      <% if attachment.is_image? %>
                        <div class="attachment-preview image-preview">
                          <div data-controller="image-decryption"
                               data-image-decryption-attachment-url-value="<%= post_attachment_path(post, attachment) %>"
                               data-image-decryption-filename-value="<%= attachment.filename %>"
                               data-image-decryption-filesize-value="<%= attachment.human_file_size %>"
                               data-image-decryption-content-type-value="<%= attachment.content_type %>">
                            <div class="loading-placeholder">
                              <span class="loading-icon">🔓</span>
                              <span class="loading-text">Decrypting image...</span>
                            </div>
                            <div class="image-overlay" style="display: none;">
                              <span class="filename"><%= attachment.filename %></span>
                              <span class="filesize"><%= attachment.human_file_size %></span>
                            </div>
                          </div>
                        </div>
                      <% elsif attachment.is_video? %>
                        <div class="attachment-preview video-preview">
                          <%= link_to post_attachment_path(post, attachment), target: '_blank', class: 'video-link' do %>
                            <div class="video-thumbnail">
                              🎥
                              <div class="video-info">
                                <span class="filename"><%= attachment.filename %></span>
                                <span class="filesize"><%= attachment.human_file_size %></span>
                              </div>
                            </div>
                          <% end %>
                        </div>
                      <% else %>
                        <div class="attachment file-attachment">
                          <%= link_to post_attachment_path(post, attachment), target: '_blank', class: 'file-link' do %>
                            📎 <%= attachment.filename %> (<%= attachment.human_file_size %>)
                          <% end %>
                        </div>
                      <% end %>
                    <% end %>
                  </div>
                <% end %>
              </div>
            </div>
          <% end %>
        <% else %>
          <div style="text-align: center; padding: 40px; color: #6c757d; font-style: italic;">
            <p>🌟 Welcome to your encrypted social network!</p>
            <p>Create your first message to get started.</p>
          </div>
        <% end %>
      </div>
    </section>
  <% else %>
    <div class="welcome-hero">
      <h2>🔐 Cipher</h2>
      <p>Secure, decentralized communication for the modern web</p>
      
      <div class="getting-started">
        <%= link_to "Create Your Identity", new_user_path, class: "btn btn-primary btn-large" %>
      </div>
    </div>

    <div class="features">
      <div class="feature">
        <h3>🔐 End-to-End Encryption</h3>
        <p>Messages are encrypted before sending. Only you and your recipients can read them.</p>
      </div>
      
      <div class="feature">
        <h3>🌐 Peer-to-Peer</h3>
        <p>Direct connections between users. No servers required.</p>
      </div>
      
      <div class="feature">
        <h3>🔑 Self-Sovereign Identity</h3>
        <p>You control your identity. No external authorities involved.</p>
      </div>
      
      <div class="feature">
        <h3>📱 Decentralized</h3>
        <p>No central authority. Your communications stay independent.</p>
      </div>
    </div>

    <!-- P2P Storage Sharing Section -->
    <section class="p2p-storage">
      <div class="storage-content">
        <div class="storage-hero">
          <h2>💾 P2P Storage</h2>
          <p class="storage-lead">
            Enable distributed storage for better data availability and redundancy.
          </p>
        </div>

        <div class="storage-benefits">
          <div class="benefit-item">
            <div class="benefit-icon">🔒</div>
            <div class="benefit-info">
              <h3>Encrypted Storage</h3>
              <p>All friends' files are encrypted end-to-end. Storage nodes only see encrypted data chunks.</p>
            </div>
          </div>

          <div class="benefit-item">
            <div class="benefit-icon">📡</div>
            <div class="benefit-info">
              <h3>Distributed Network</h3>
              <p>Files are replicated across multiple nodes for better availability and fault tolerance.</p>
            </div>
          </div>

          <div class="benefit-item">
            <div class="benefit-icon">🌐</div>
            <div class="benefit-info">
              <h3>Better Performance</h3>
              <p>More storage nodes means faster downloads and better network resilience.</p>
            </div>
          </div>
        </div>

        <div class="storage-actions">
          <h3>Configure Storage</h3>
          <p>Set how much disk space to allocate for friends' data.</p>
          <div class="action-buttons">
            <%= link_to "Storage Settings", local_hosting_users_path, class: "btn btn-primary" %>
          </div>
        </div>
      </div>
    </section>

    <!-- Mission Statement Section -->
    <section class="mission-statement">
      <div class="mission-content">
        <h2>🛡️ Our Mission</h2>
        <div class="mission-text">
          <p class="mission-lead">
            Private messaging without surveillance or data collection.
          </p>
          
          <div class="mission-principles">
            <div class="principle">
              <div class="principle-icon">🚫</div>
              <div class="principle-content">
                <h3>No Servers, No Surveillance</h3>
                <p>Messages go directly between users. No servers store your conversations.</p>
              </div>
            </div>
            
            <div class="principle">
              <div class="principle-icon">🔒</div>
              <div class="principle-content">
                <h3>No Data Harvesting</h3>
                <p>We can't read your messages or track you. Your data stays yours.</p>
              </div>
            </div>
            
            <div class="principle">
              <div class="principle-icon">📖</div>
              <div class="principle-content">
                <h3>Open Source Transparency</h3>
                <p>All code is public. Audit it, fork it, improve it.</p>
              </div>
            </div>
            
            <div class="principle">
              <div class="principle-icon">❤️</div>
              <div class="principle-content">
                <h3>Connect with Loved Ones</h3>
                <p>Share files and messages privately with friends and family.</p>
              </div>
            </div>
          </div>
          
          <div class="mission-call-to-action">
            <p class="mission-cta-text">
              <strong>Private messaging by design.</strong> 
              No tracking, no data collection, no surveillance.
            </p>
            <div class="mission-links">
              <a href="https://github.com/anthropics/cipher" target="_blank" class="btn btn-outline">
                📖 View Source Code
              </a>
              <%= link_to new_user_path, class: "btn btn-secondary" do %>
                🚀 Get Started
              <% end %>
            </div>
          </div>
        </div>
      </div>
    </section>
  <% end %>
</div>

<!-- JavaScript removed for local-only app simplicity -->

<style>
.message-actions {
  display: flex;
  gap: var(--content-spacing-sm);
  margin-bottom: var(--content-spacing-md);
  flex-wrap: wrap;
}

.message-actions .btn {
  font-size: 0.95em;
}

.form-buttons {
  display: flex;
  gap: var(--content-spacing-sm);
  margin-top: var(--content-spacing-sm);
  flex-wrap: wrap;
}

.form-buttons .btn {
  font-size: 0.95em;
}

/* Use consistent modern welcome-hero styling from homepage.css */

/* Message header layout */
.message-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: var(--content-spacing-sm);
}

.message-meta {
  display: flex;
  flex-direction: column;
  gap: var(--content-spacing-xs);
}

.message-header .message-actions {
  margin-bottom: 0;
  gap: var(--content-spacing-xs);
}

.btn-delete {
  background: transparent;
  border: none;
  color: #dc3545;
  text-decoration: none;
  font-size: 1.1em;
  padding: 4px 8px;
  border-radius: 4px;
  transition: background-color 0.2s ease;
  cursor: pointer;
}

.btn-delete:hover {
  background-color: rgba(220, 53, 69, 0.1);
  text-decoration: none;
}

@media (max-width: 768px) {
  .message-actions {
    flex-direction: column;
  }
  
  .message-header {
    flex-direction: column;
    align-items: flex-start;
    gap: var(--content-spacing-sm);
  }
  
  .message-header .message-actions {
    align-self: flex-end;
  }
  
  /* Mobile styles for welcome-hero handled by homepage.css */
}
</style>

